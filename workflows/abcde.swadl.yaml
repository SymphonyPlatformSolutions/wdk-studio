id: abcde
variables:
  ts:
activities:
  - send-message:
      id: clientForm
      on:
        message-received:
          content: /onboard
      content: |
        <messageML>
          <p><b>New Onboarding Request</b></p>
          <form id="clientForm">
            <text-field name="companyName" label="Company Name"></text-field>
            <text-field name="countryCode"  label="Country Code" maxlength="3"></text-field>
            <select name="product" label="Product" data-placeholder="select a product...">
              <option value="equities">Equities</option>
              <option value="fx cash">FX cash</option>
              <option value="derivatives">Derivatives</option>
              <option value="cash">Cash</option>
            </select>
            <button name="submit" type="action">Send Request</button>
          </form>
        </messageML>
  - update-message:
      id: progressStatus
      on:
        form-replied:
          form-id: clientForm
          exclusive: true
      message-id: ${clientForm.outputs.msgId}
      content: |
        <messageML>
          <p>Synchronizing with the GLEIF database...</p>
        </messageML>
  - execute-request:
      id: checkGleif
      method: GET
      headers:
        Content-Type: application/json
        Accept: application/json
      url: https://api.gleif.org/api/v1/lei-records?filter[entity.legalName]=${clientForm.companyName}&page[number]=1&page[size]=5&filter[entity.legalAddress.country]=${clientForm.countryCode}
  - update-message:
      id: resFailure
      if: ${checkGleif.outputs.body.data.size() == 0}
      on:
        activity-completed:
          activity-id: checkGleif
      message-id: ${progressStatus.outputs.msgId}
      content: |
        <messageML>
          <p>Company information not found, onboarding process aborted.</p>
        </messageML>
  - execute-script:
      id: resSuccess
      on:
        activity-completed:
          activity-id: checkGleif
      else: {}
      script: |
        variables.ts = (new Date()).getTime()
  - update-message:
      id: statusMessage
      on:
        activity-completed:
          activity-id: resSuccess
      message-id: ${progressStatus.outputs.msgId}
      content: |
        <messageML>
          <p>
            <b>Onboarding Request ${variables.ts}</b> <span style="border-radius:8px;background-color:#2ac22a;color:#ffffff;padding: 2px 5px">${clientForm.product}</span>
          </p>
          <div style="padding: 10px;border: 1px #ccc solid;width: 350px;margin: 20px">
            ${checkGleif.outputs.body.data[0].attributes.entity.legalName.name}<br/>
            ${checkGleif.outputs.body.data[0].attributes.entity.legalAddress.addressLines[0]}<br/>
            ${checkGleif.outputs.body.data[0].attributes.entity.legalAddress.city}, ${checkGleif.outputs.body.data[0].attributes.entity.legalAddress.postalCode}, ${checkGleif.outputs.body.data[0].attributes.entity.legalAddress.country}
          </div>
          <p>
            Thank you we have received your onboarding request.<br/>
            We will be back soon with an onboarder and any other information we require.
          </p>
        </messageML>
  